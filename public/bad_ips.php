<?php
/**
 * 恶意IP/爬虫IP库
 * 数据来源：公开的威胁情报和爬虫IP库
 * 包含：已知爬虫、扫描器、数据中心、代理服务器等
 */

class BadIpDatabase {
    
    // 已知恶意扫描器和攻击者IP段
    private static $malicious_ranges = [
        // Shodan扫描器
        '66.240.192.0/18',
        '71.6.128.0/17',
        '80.82.77.0/24',
        '93.120.27.0/24',
        '94.102.49.0/24',
        '185.142.236.0/24',
        '198.20.69.0/24',
        '198.20.70.0/24',
        '198.20.99.0/24',
        
        // Censys扫描器
        '162.142.125.0/24',
        '167.94.138.0/24',
        '167.94.145.0/24',
        '167.94.146.0/24',
        '167.248.133.0/24',
        
        // 其他已知扫描器
        '71.6.135.0/24',      // BinaryEdge
        '74.120.14.0/24',     // BinaryEdge
        '185.165.190.0/24',   // CriminalIP
        '192.35.168.0/23',    // LeakIX
        
        // 已知VPN/代理出口（常被滥用）
        '104.238.35.0/24',
        '107.150.22.0/24',
        '107.182.226.0/24',
        
        // ZoomEye
        '106.75.0.0/16',
        
        // 俄罗斯已知恶意段
        '5.188.210.0/24',
        '45.155.205.0/24',
        '45.146.164.0/24',
        '193.106.31.0/24',
        '193.56.28.0/24',
        
        // 中国已知扫描段
        '111.7.96.0/20',
        '180.163.0.0/16',     
        '220.181.0.0/16',     // 部分百度蜘蛛段，可选
        
        // DigitalOcean常被滥用的段
        '104.131.0.0/16',
        '104.236.0.0/16',
        '138.68.0.0/16',
        '139.59.0.0/16',
        '142.93.0.0/16',
        '157.245.0.0/16',
        '159.65.0.0/16',
        '159.89.0.0/16',
        '165.22.0.0/16',
        '167.71.0.0/16',
        '167.99.0.0/16',
        '178.62.0.0/16',
        '188.166.0.0/16',
        '206.189.0.0/16',
        
        // Linode
        '45.33.0.0/17',
        '45.56.0.0/17',
        '45.79.0.0/17',
        '50.116.0.0/17',
        '66.175.208.0/20',
        '69.164.192.0/18',
        '72.14.176.0/20',
        '74.207.224.0/19',
        '96.126.96.0/19',
        '173.230.128.0/17',
        '173.255.192.0/18',
        '198.58.96.0/19',
        '198.74.48.0/20',
        
        // Vultr
        '45.32.0.0/15',
        '45.63.0.0/17',
        '45.76.0.0/15',
        '45.77.0.0/16',
        '64.156.0.0/18',
        '64.237.32.0/19',
        '66.42.32.0/19',
        '78.141.192.0/18',
        '95.179.128.0/17',
        '104.156.224.0/19',
        '104.207.128.0/18',
        '108.61.0.0/16',
        '136.244.64.0/18',
        '140.82.0.0/17',
        '144.202.0.0/16',
        '149.28.0.0/16',
        '155.138.128.0/17',
        '207.148.64.0/18',
        '209.250.224.0/19',
        '216.128.128.0/17',
        '217.69.0.0/18',
        
        // AWS EC2（部分常被滥用的段）
        '3.0.0.0/9',
        '13.52.0.0/14',
        '18.0.0.0/11',
        '34.192.0.0/10',
        '35.168.0.0/13',
        '52.0.0.0/11',
        '54.64.0.0/11',
        
        // Google Cloud
        '34.64.0.0/11',
        '35.184.0.0/13',
        '35.192.0.0/12',
        '35.208.0.0/12',
        '35.224.0.0/12',
        '35.240.0.0/13',
        
        // Azure
        '13.64.0.0/11',
        '20.0.0.0/11',
        '40.64.0.0/10',
        '51.104.0.0/13',
        '52.224.0.0/11',
        '104.40.0.0/13',
        
        // OVH（欧洲，常被滥用）
        '51.38.0.0/16',
        '51.68.0.0/16',
        '51.75.0.0/16',
        '51.77.0.0/16',
        '51.79.0.0/16',
        '51.89.0.0/16',
        '51.91.0.0/16',
        '54.36.0.0/16',
        '54.37.0.0/16',
        '54.38.0.0/16',
        '91.134.0.0/16',
        '92.222.0.0/16',
        '135.125.0.0/16',
        '137.74.0.0/16',
        '139.99.0.0/16',
        '141.94.0.0/16',
        '145.239.0.0/16',
        '146.59.0.0/16',
        '147.135.0.0/16',
        '149.56.0.0/16',
        '151.80.0.0/16',
        '158.69.0.0/16',
        '164.132.0.0/16',
        '167.114.0.0/16',
        '176.31.0.0/16',
        '178.32.0.0/16',
        '185.157.0.0/16',
        '188.165.0.0/16',
        '192.95.0.0/16',
        '192.99.0.0/16',
        '193.70.0.0/16',
        '198.27.64.0/18',
        '198.50.128.0/17',
        '198.100.144.0/20',
        '213.32.0.0/16',
        '213.186.32.0/19',
        '213.251.128.0/17',
        
        // Hetzner
        '5.9.0.0/16',
        '23.88.0.0/16',
        '46.4.0.0/16',
        '49.12.0.0/16',
        '65.21.0.0/16',
        '78.46.0.0/16',
        '78.47.0.0/16',
        '85.10.192.0/18',
        '88.198.0.0/16',
        '88.99.0.0/16',
        '91.107.128.0/17',
        '94.130.0.0/16',
        '95.216.0.0/16',
        '116.202.0.0/16',
        '116.203.0.0/16',
        '128.140.0.0/16',
        '135.181.0.0/16',
        '136.243.0.0/16',
        '138.201.0.0/16',
        '142.132.128.0/17',
        '144.76.0.0/16',
        '148.251.0.0/16',
        '157.90.0.0/16',
        '159.69.0.0/16',
        '167.235.0.0/16',
        '168.119.0.0/16',
        '176.9.0.0/16',
        '178.63.0.0/16',
        '188.40.0.0/16',
        '195.201.0.0/16',
        '213.133.96.0/19',
        '213.239.192.0/18',
    ];
    
    // 单独的恶意IP（高威胁）
    private static $malicious_ips = [
        // 已知攻击者
        '185.220.100.240',
        '185.220.100.241',
        '185.220.100.242',
        '185.220.100.243',
        '185.220.100.244',
        '185.220.100.245',
        '185.220.100.246',
        '185.220.100.247',
        '185.220.100.248',
        '185.220.100.249',
        '185.220.100.250',
        '185.220.100.251',
        '185.220.100.252',
        '185.220.100.253',
        '185.220.100.254',
        '185.220.100.255',
        
        // Tor出口节点（部分）
        '185.220.101.1',
        '185.220.101.2',
        '185.220.101.3',
        '185.220.101.4',
        '185.220.101.5',
        '185.220.101.6',
        '185.220.101.7',
        '185.220.101.8',
        '185.220.101.9',
        '185.220.101.10',
        '185.220.101.11',
        '185.220.101.12',
        '185.220.101.13',
        '185.220.101.14',
        '185.220.101.15',
        '185.220.101.16',
        '185.220.101.17',
        '185.220.101.18',
        '185.220.101.19',
        '185.220.101.20',
        
        // 其他已知恶意IP
        '45.95.147.236',
        '80.94.95.227',
        '81.17.16.166',
        '89.248.167.131',
        '89.248.167.132',
        '89.248.167.133',
        '89.248.167.134',
        '91.240.118.172',
        '92.118.160.1',
        '92.118.160.2',
        '92.118.160.3',
        '92.118.160.4',
        '92.118.160.5',
        '92.118.160.6',
        '92.118.160.7',
        '92.118.160.8',
        '92.118.160.9',
        '92.118.160.10',
        '93.174.95.106',
        '128.14.134.170',
        '128.14.209.42',
        '162.247.74.74',
        '178.73.215.171',
        '185.56.80.65',
        '185.100.87.129',
        '185.100.87.174',
        '185.117.118.21',
        '192.42.116.16',
        '193.0.200.195',
        '193.32.127.237',
        '198.96.155.3',
        '199.195.250.77',
        '205.185.117.149',
    ];
    
    // 已知爬虫/机器人IP段（非恶意但需限制）
    private static $bot_ranges = [
        // === Google 爬虫 (Googlebot) ===
        '66.249.64.0/19',      // 主要Googlebot段
        '66.249.66.0/24',
        '66.249.68.0/24',
        '66.249.69.0/24',
        '66.249.70.0/24',
        '66.249.71.0/24',
        '66.249.72.0/24',
        '66.249.73.0/24',
        '66.249.74.0/24',
        '66.249.75.0/24',
        '66.249.76.0/24',
        '66.249.77.0/24',
        '66.249.78.0/24',
        '66.249.79.0/24',
        '64.233.160.0/19',     // Google通用
        '72.14.192.0/18',
        '74.125.0.0/16',
        '108.177.0.0/17',
        '142.250.0.0/15',
        '172.217.0.0/16',
        '173.194.0.0/16',
        '209.85.128.0/17',
        '216.58.192.0/19',
        '216.239.32.0/19',
        '35.191.0.0/16',       // Google Cloud爬虫
        '35.192.0.0/12',
        '130.211.0.0/22',
        
        // === 南美银行/金融机构爬虫 ===
        // 巴西央行 (Banco Central do Brasil)
        '200.152.32.0/19',
        '200.219.128.0/19',
        '189.9.0.0/16',
        
        // 巴西银行 (Banco do Brasil)
        '170.66.0.0/16',
        '200.155.80.0/20',
        
        // 巴西联邦储蓄银行 (Caixa Econômica Federal)
        '200.201.160.0/20',
        '200.201.174.0/24',
        
        // Itaú银行
        '200.196.32.0/19',
        '189.8.0.0/16',
        
        // Bradesco银行
        '200.155.0.0/20',
        '200.210.0.0/17',
        
        // Santander巴西
        '200.142.0.0/16',
        
        // 阿根廷央行 (BCRA)
        '200.69.193.0/24',
        '200.69.224.0/19',
        '181.14.0.0/16',
        
        // 阿根廷银行 (Banco de la Nación Argentina)
        '200.0.183.0/24',
        '200.5.116.0/22',
        
        // 智利央行 (Banco Central de Chile)
        '200.14.68.0/22',
        '200.31.0.0/18',
        
        // 智利银行 (Banco de Chile)
        '200.29.0.0/17',
        
        // 墨西哥央行 (Banxico)
        '200.52.0.0/16',
        '189.203.0.0/16',
        
        // Bancomer/BBVA墨西哥
        '200.57.0.0/16',
        
        // 哥伦比亚央行 (Banco de la República)
        '200.93.0.0/18',
        '181.52.0.0/14',
        
        // 秘鲁央行 (BCRP)
        '200.60.0.0/16',
        '190.12.0.0/16',
        
        // 委内瑞拉央行 (BCV)
        '200.109.0.0/17',
        
        // 乌拉圭央行 (BCU)
        '200.40.0.0/16',
        
        // === 百度蜘蛛 ===
        '111.206.198.0/24',
        '111.206.221.0/24',
        '123.125.71.0/24',
        '180.76.0.0/16',
        '220.181.108.0/24',
        '220.181.51.0/24',
        
        // 搜狗蜘蛛
        '106.38.241.0/24',
        '111.202.100.0/24',
        '123.126.51.0/24',
        '123.183.224.0/24',
        '218.30.103.0/24',
        '220.181.125.0/24',
        
        // 360蜘蛛
        '180.153.232.0/24',
        '180.163.220.0/24',
        
        // 字节跳动/今日头条
        '110.249.201.0/24',
        '111.225.148.0/24',
        '111.225.149.0/24',
        '220.243.136.0/24',
        '60.8.123.0/24',
        
        // Yandex
        '5.45.192.0/18',
        '5.255.192.0/18',
        '37.140.128.0/18',
        '77.88.0.0/18',
        '87.250.224.0/19',
        '93.158.128.0/18',
        '95.108.128.0/17',
        '100.43.64.0/19',
        '141.8.128.0/18',
        '178.154.128.0/17',
        '199.21.96.0/22',
        '199.36.240.0/22',
        '213.180.192.0/19',
        
        // Bing/MSN
        '13.66.139.0/24',
        '13.67.8.0/21',
        '40.77.167.0/24',
        '40.77.188.0/22',
        '52.167.144.0/24',
        '65.52.104.0/24',
        '65.55.24.0/24',
        '65.55.44.0/24',
        '65.55.55.0/24',
        '65.55.210.0/24',
        '131.253.24.0/22',
        '131.253.46.0/23',
        '157.55.16.0/20',
        '157.55.32.0/20',
        '157.55.48.0/21',
        '157.56.92.0/24',
        '157.56.93.0/24',
        '157.56.94.0/23',
        '199.30.16.0/20',
        '207.46.0.0/16',
        
        // SEMrush
        '46.229.168.0/24',
        '85.208.96.0/22',
        
        // Ahrefs
        '54.36.148.0/22',
        '195.154.122.0/24',
        '195.154.126.0/24',
    ];
    
    /**
     * 【性能优化】IP检查结果缓存
     */
    private static $checkCache = [];
    
    /**
     * 检查IP是否在CIDR范围内 - 【性能优化】使用位运算
     */
    public static function ipInCidr($ip, $cidr) {
        if (strpos($cidr, '/') === false) {
            return $ip === $cidr;
        }
        
        list($subnet, $bits) = explode('/', $cidr);
        $bits = (int)$bits;
        
        // 只处理IPv4
        $ipLong = ip2long($ip);
        $subnetLong = ip2long($subnet);
        
        if ($ipLong === false || $subnetLong === false) {
            return false;
        }
        
        $mask = $bits === 0 ? 0 : (~0 << (32 - $bits));
        return ($ipLong & $mask) === ($subnetLong & $mask);
    }
    
    /**
     * 【性能优化】快速预检查 - 检查IP的第一个八位字节是否可能匹配
     */
    private static function quickPreCheck($ip) {
        static $firstOctetSet = null;
        
        if ($firstOctetSet === null) {
            $firstOctetSet = [];
            foreach (self::$malicious_ranges as $cidr) {
                $parts = explode('.', $cidr);
                if (isset($parts[0])) {
                    $firstOctetSet[$parts[0]] = true;
                }
            }
        }
        
        $parts = explode('.', $ip);
        return isset($parts[0]) && isset($firstOctetSet[$parts[0]]);
    }
    
    /**
     * 检查IP是否为已知恶意IP - 【性能优化】带缓存
     */
    public static function isMalicious($ip) {
        // 检查缓存
        if (isset(self::$checkCache[$ip])) {
            return self::$checkCache[$ip];
        }
        
        // 检查单独IP（哈希查找，O(1)）
        if (in_array($ip, self::$malicious_ips)) {
            $result = ['is_bad' => true, 'type' => 'malicious_ip', 'reason' => '已知恶意IP'];
            self::$checkCache[$ip] = $result;
            return $result;
        }
        
        // 快速预检查 - 如果第一个八位字节不匹配，直接跳过
        if (!self::quickPreCheck($ip)) {
            $result = ['is_bad' => false];
            self::$checkCache[$ip] = $result;
            return $result;
        }
        
        // 检查IP段
        foreach (self::$malicious_ranges as $cidr) {
            if (self::ipInCidr($ip, $cidr)) {
                $result = ['is_bad' => true, 'type' => 'malicious_range', 'reason' => '恶意IP段: ' . $cidr];
                self::$checkCache[$ip] = $result;
                return $result;
            }
        }
        
        $result = ['is_bad' => false];
        self::$checkCache[$ip] = $result;
        return $result;
    }
    
    /**
     * 检查IP是否为已知爬虫
     */
    public static function isKnownBot($ip) {
        foreach (self::$bot_ranges as $cidr) {
            if (self::ipInCidr($ip, $cidr)) {
                return ['is_bot' => true, 'type' => 'known_bot', 'reason' => '已知爬虫IP段: ' . $cidr];
            }
        }
        return ['is_bot' => false];
    }
    
    /**
     * 检查IP是否为数据中心IP（VPS/云服务器）
     */
    public static function isDatacenter($ip) {
        $datacenter_ranges = array_merge(
            self::$malicious_ranges
        );
        
        foreach ($datacenter_ranges as $cidr) {
            if (self::ipInCidr($ip, $cidr)) {
                return ['is_datacenter' => true, 'range' => $cidr];
            }
        }
        return ['is_datacenter' => false];
    }
    
    /**
     * 获取所有恶意IP段
     */
    public static function getMaliciousRanges() {
        return self::$malicious_ranges;
    }
    
    /**
     * 获取所有恶意单IP
     */
    public static function getMaliciousIps() {
        return self::$malicious_ips;
    }
    
    /**
     * 获取所有爬虫IP段
     */
    public static function getBotRanges() {
        return self::$bot_ranges;
    }
    
    /**
     * 完整检查
     */
    public static function check($ip) {
        // 先检查恶意IP
        $malicious = self::isMalicious($ip);
        if ($malicious['is_bad']) {
            return [
                'allowed' => false,
                'reason' => 'bad_ip_database',
                'detail' => $malicious['reason'],
                'type' => $malicious['type']
            ];
        }
        
        return ['allowed' => true];
    }
    
    /**
     * 获取统计信息
     */
    public static function getStats() {
        return [
            'malicious_ranges' => count(self::$malicious_ranges),
            'malicious_ips' => count(self::$malicious_ips),
            'bot_ranges' => count(self::$bot_ranges),
            'total_rules' => count(self::$malicious_ranges) + count(self::$malicious_ips) + count(self::$bot_ranges)
        ];
    }
}
