; PHP-FPM 高并发优化配置
; 适用于短链服务高并发场景

[www]
user = www-data
group = www-data

; 监听配置
listen = 127.0.0.1:9000
listen.allowed_clients = 127.0.0.1

; 进程管理模式
; static - 固定进程数，高并发首选
; dynamic - 动态调整
; ondemand - 按需创建
pm = static

; 进程数配置（根据CPU核心数调整）
; 建议: CPU核心数 * 2 到 CPU核心数 * 4
pm.max_children = 50

; 动态模式配置（pm = dynamic 时生效）
pm.start_servers = 10
pm.min_spare_servers = 5
pm.max_spare_servers = 20

; 请求限制
pm.max_requests = 10000

; 进程状态页
pm.status_path = /fpm-status

; 慢日志
slowlog = /var/log/php-fpm/slow.log
request_slowlog_timeout = 2s

; 超时设置
request_terminate_timeout = 30s

; 环境变量
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

; PHP配置覆盖
php_admin_value[error_log] = /var/log/php-fpm/error.log
php_admin_flag[log_errors] = on
php_admin_value[memory_limit] = 128M
php_admin_value[max_execution_time] = 30
php_admin_value[max_input_time] = 30

; OPcache 配置（需在 php.ini 中启用）
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 128
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 10000
php_admin_value[opcache.validate_timestamps] = 0
php_admin_value[opcache.revalidate_freq] = 0
php_admin_value[opcache.fast_shutdown] = 1
php_admin_value[opcache.enable_cli] = 0

; APCu 配置
php_admin_value[apc.enabled] = 1
php_admin_value[apc.shm_size] = 128M
php_admin_value[apc.ttl] = 3600
php_admin_value[apc.enable_cli] = 0

; 文件上传（API需要）
php_admin_value[upload_max_filesize] = 10M
php_admin_value[post_max_size] = 10M

; Session配置（禁用，API无状态）
php_admin_value[session.auto_start] = 0
